# Аудит backend: покерный клуб (спортивный, без денежных призов)

## 1. Обзор архитектуры

### 1.1 Структура слоёв

- **Роуты** (`src/routes/`) — маршрутизация, часть роутов подключает `authMiddleware`, часть нет.
- **Контроллеры** (`src/controllers/`) — HTTP-слой: парсинг body/query/params, вызов сервисов, проверки роли (ADMIN) внутри экшенов.
- **Сервисы** (`src/services/`) — бизнес-логика, работа с TypeORM репозиториями.
- **Модели** (`src/models/`) — сущности TypeORM, без отдельного слоя репозиториев (используется `AppDataSource.getRepository()` в сервисах).

**Плюсы:** понятное разделение routes → controllers → services; одна точка входа (Express).

**Минусы:**
- Нет единого DTO/валидации (body принимается «как есть»).
- Роль ADMIN проверяется вручную в каждом экшене (`if (req.user?.role !== 'ADMIN')`), а не через `requireRole` middleware — дублирование и риск пропусков.
- Нет глобального обработчика ошибок — в каждом контроллере свой `try/catch` и формат ответа (`error.message` может утекать наружу).
- **God-объекты:** `LiveTournamentService` и `TournamentService` делают много разного; при росте лучше разбить (например, отдельно FinishTournament, Rebuy/Addon, Seating).

### 1.2 TypeORM и консистентность

- Используется `synchronize: true` в development — удобно, но в проде нужны миграции.
- Транзакции не используются там, где нужна атомарность: например, `OrderService.createOrder` — создание заказа и списание баланса в два шага; при падении между ними возможна рассинхронизация. Аналогично `cancelOrder` (возврат на баланс).
- Связи и каскады в целом настроены корректно (Club → ClubTable, Tournament → TournamentReward и т.д.).

### 1.3 Роуты и авторизация (сводка)

| Модуль        | authMiddleware | Примечание |
|---------------|----------------|------------|
| /auth         | Только на GET /me | Регистрация/логин/refresh публичные — ок. |
| /user         | Да (весь роутер) | Депозит и операции только для своего пользователя — ок. |
| /tournaments  | Да             | ADMIN проверяется в контроллерах. |
| /clubs        | Да             | ADMIN в контроллерах. |
| /rewards      | Да             | ADMIN в контроллерах. |
| /blind-structures | Да         | ADMIN в контроллерах. |
| /leaderboards | Да             | ADMIN в контроллерах. |
| /mmr          | Да             | ADMIN в контроллерах. |
| **/menu**     | **Нет**        | **Критично:** создание/изменение/удаление категорий и позиций доступно без авторизации. |
| **/orders**   | **Нет**        | **Критично:** создание заказа, «мои заказы», отмена, получение по ID — без авторизации; userId берётся из body/query. |
| **/statistics** | **Нет**      | Любой может запросить статистику любого пользователя по userId. |
| **/achievements** | **Нет**   | Любой может смотреть достижения любого userId; POST /seed и /check доступны без роли ADMIN. |

---

## 2. Логика и консистентность по ролям

### 2.1 Гость (неавторизованный)

- **Доступно:** POST /auth/register, /auth/login, /auth/refresh, **все GET /menu/..., все /orders/..., все /statistics/..., все /achievements/...** (из-за отсутствия auth на этих роутерах).
- **Риск:** утечка данных (чужие заказы, статистика, достижения), создание заказов от имени любого userId, списание депозита чужого аккаунта, изменение меню.

### 2.2 Обычный пользователь (авторизованный)

- **Депозит:** пополнение и история привязаны к `req.user.userId` через PlayerProfile — корректно.
- **Турниры:** регистрация/снятие проверяют статус (REG_OPEN/LATE_REG); повторная регистрация обрабатывается (ошибка «Player already registered»). Ребаи/аддоны/выбытие доступны только через админские эндпоинты — читерить через API нельзя.
- **Заказы (текущая реализация):** контроллер берёт `userId` из `(req as any).user?.id` (в AuthRequest поле называется `userId`, не `id`) или из body — при отсутствии auth на роутере пользователь может передать чужой `userId` и списать деньги с чужого депозита. Получение заказа по ID и отмена не проверяют владельца — можно отменить чужой заказ.

### 2.3 Администратор

- Критические операции (турниры, клубы, рассадка, live, MMR, лидерборды, структуры блайндов, награды) защищены проверкой `req.user.role === 'ADMIN'`.
- **Меню и заказы:** из-за отсутствия auth на роутере админские действия (создание/изменение категорий и позиций, статистика заказов, смена статуса заказа) доступны кому угодно, в т.ч. гостю.

### 2.4 Edge-cases по модулям

- **Турниры:** регистрация в FINISHED/ARCHIVED запрещена; повторная регистрация — ошибка; лимит по количеству участников/столов не проверяется (можно регаться «в переполненный» турнир, если не добавлена проверка).
- **Заказы:** нет проверки «заказ принадлежит текущему пользователю» при GET /orders/:id и POST /orders/:id/cancel.
- **Статистика/достижения:** любой userId в URL — нет проверки «только свой профиль или ADMIN».
- **MMR/лидерборды:** пересчёт только по турниру; отмена/перерасчёт турнира — отдельно не рассматривались (логика в finishTournament и recalculate).

---

## 3. Инварианты доменной модели

Рекомендуемые инварианты и текущее состояние:

| Инвариант | Поддержка |
|-----------|-----------|
| Сумма входов/ребаев/аддонов = currentStack у активного игрока | Да: currentStack обновляется при ребае/аддоне; пересчёт averageStack по активным. |
| Турнир не может быть RUNNING и ARCHIVED одновременно | Да: статус один. |
| Игрок не может сидеть за двумя столами одного турнира | Да: рассадка создаёт места в TableSeat, один игрок — один активный seat. |
| Депозит не уходит в минус при заказе | Да: проверка `depositBalance >= totalAmount` перед списанием. |
| Отмена заказа возвращает ровно totalAmount на депозит | Да: возврат по полю заказа. |
| Атомарность «создание заказа + списание баланса» | **Нет:** два отдельных сохранения; при сбое между ними возможны «висящий» заказ или списание без заказа. Рекомендация: обернуть в транзакцию. |

---

## 4. Качество кода и TypeScript

- **Типизация:** во многих контроллерах `catch (error: any)` и `res.json({ error: error.message })`. Лучше: общий тип для API-ошибки, не пробрасывать внутренние сообщения наружу в проде.
- **AuthRequest:** поле `user.userId` (не `user.id`). В OrderController используется `(req as any).user?.id` — опечатка/несоответствие, при включённом auth нужно использовать `userId`.
- **Enum/union:** статусы турнира, OrderStatus, роли в User заданы через enum/типы; для ролей можно вынести константы (например, `ROLES.ADMIN`) и использовать `requireRole([ROLES.ADMIN])`.
- **Дублирование:** проверка ADMIN повторяется в десятках мест; вынести в `requireRole(['ADMIN'])` и вешать на роуты.

---

## 5. Ошибки, валидация и безопасность

- **Формат ошибок:** в основном `{ error: string }`; в части ответов есть `details: error.message` — риск утечки внутренней информации.
- **Валидация:** входные данные (body/query/params) проверяются выборочно (наличие полей, иногда границы). Нет единой схемы (Zod/Joi/class-validator) — рекомендуем ввести для критичных эндпоинтов (создание заказа, пополнение, регистрация в турнир).
- **Уязвимости:**
  - Доступ к чужим ресурсам по ID: заказы, статистика, достижения — без проверки владельца/роли.
  - Явное доверие к `userId` из тела/query в заказах и к `userId` в URL в statistics/achievements.
  - Меню: изменение данных без авторизации.

---

## 6. Консистентность после удаления денежных призов

- **Депозит:** используется только для заказов (OrderService списывает/возвращает баланс). Регистрация в турнир не списывает депозит (TournamentService не вызывает FinancialService при регистрации) — соответствует ТЗ.
- **PlayerOperation:** enum содержит DEPOSIT_TOPUP, DEPOSIT_WITHDRAWAL, BUYIN, REBUY, ADDON, ORDER_PAYMENT. Типов PRIZE/REFUND в enum нет. В FinancialService есть методы `addBalance(..., operationType: 'PRIZE' | 'REFUND')` и `deductBalance` — они нигде не вызываются; при сохранении операции с типом PRIZE БД выдаст ошибку (нет в enum). Рекомендация: удалить неиспользуемые методы или оставить только REFUND для отмены заказа и добавить REFUND в enum при необходимости; убрать PRIZE из контракта.

---

## 7. Тестирование и наблюдаемость

- **Тесты:** в репозитории есть `api-tests.http` для ручной проверки; unit/integration-тестов по коду не видно. Рекомендуемый минимум: auth (логин, неверный токен), турниры (создание, регистрация, смена статуса), заказы (создание при достаточном/недостаточном балансе, отмена), проверка прав (доступ к чужим заказам/статистике без админа — должен быть 403).
- **Логирование:** разрозненные console.log в сервисах (например, finishTournament). Рекомендация: структурированные логи (уровень, модуль, событие, id турнира/заказа) и ключевые события (турнир завершён, заказ создан/отменён, неудачная оплата депозитом).
- **Метрики:** не реализованы; при необходимости — счётчики запросов, ошибок, время выполнения критичных операций.

---

## 8. Расхождение API с описанием

- В описании: `GET /rewards/tournament/:tournamentId` и `POST /rewards/tournament/:tournamentId`. В коде: награды турнира задаются через `PATCH /tournaments/:id/rewards`; каталог наград — `GET/POST /rewards`, без подроута `/rewards/tournament/...`. Имеет смысл привести описание в соответствие с реализацией или добавить эндпоинты по турниру под /rewards.
- В описании: `GET /clubs/:id/availability` (количество столов и занятость). В роутах клуба такого эндпоинта нет — либо добавить, либо убрать из спецификации.

---

## 9. Рекомендации по приоритетам

### Критично (безопасность)

1. Подключить `authMiddleware` к роутерам **menu**, **orders**, **statistics**, **achievements**.
2. В **orders:** брать `userId` только из `req.user.userId`; в GET /orders/:id и POST /orders/:id/cancel проверять, что заказ принадлежит текущему пользователю (или админ).
3. В **statistics** и **achievements:** разрешать доступ к данным по userId только если `req.user.userId === userId` или `req.user.role === 'ADMIN'`.
4. В **menu:** на POST/PATCH/DELETE категорий и позиций вешать `requireRole(['ADMIN'])` (или эквивалент).
5. В **orders:** на GET /, GET /statistics, GET /tournament/:id, PATCH /:id/status — только для ADMIN.

### Важно (целостность и качество)

6. Ввести транзакцию в `OrderService.createOrder` и в `cancelOrder` (создание/обновление заказа + изменение баланса в одной транзакции).
7. Вынести проверку роли ADMIN в middleware `requireRole` и применять к админским роутам вместо дублирования в контроллерах.
8. Глобальный обработчик ошибок: единый формат ответа, в проде не отдавать `error.message` от внутренних исключений.
9. Добавить эндпоинт GET /clubs/:id/availability или убрать из спецификации.

### Желательно

10. Валидация входных данных (Zod/class-validator) для auth, заказов, пополнения депозита, создания турнира.
11. Удалить или сузить `FinancialService.addBalance`/`deductBalance`; при использовании REFUND — добавить тип в enum операций и вызывать явно при отмене заказа (если нужна история).
12. Набор автоматических тестов (integration/e2e) по сценариям выше.

---

## Аудит: модель «платим за игру — не зарабатываем»

**Идея:** игроки **платят** за участие (регистрация, ребай, аддон) — списание с депозита при оплате DEPOSIT. **Заработать** деньги в турнире нельзя: за победу и призовые места выдаются только **призы, которые создаёт админ** (немонетарные Reward). Депозит также используется для заказов в кафе.

### Реализовано

| Область | Поведение |
|--------|-----------|
| **Регистрация на турнир** | При `paymentMethod === 'DEPOSIT'` и `buyInCost > 0` вызывается `FinancialService.deductBalance(…, 'BUYIN', …)` до сохранения регистрации. При ошибке сохранения — возврат (REFUND). ✅ |
| **Отмена регистрации** | При `paymentMethod === 'DEPOSIT'` и `buyInCost > 0` перед удалением регистрации вызывается `addBalance(…, 'REFUND', …)` — возврат бай-ина на депозит. ✅ |
| **Ребаи / аддоны** | При стоимости > 0 вызывается `deductBalance(…, 'REBUY'|'ADDON', …)` до создания операции и начисления фишек. ✅ |
| **Завершение турнира** | На баланс ничего не начисляется. Призы за места задаются админом через TournamentReward (модель Reward — немонетарная). ✅ |
| **Операции** | В enum `PlayerOperation`: DEPOSIT_TOPUP, DEPOSIT_WITHDRAWAL, BUYIN, REBUY, ADDON, ORDER_PAYMENT, **REFUND**. Типа PRIZE нет — денежных призов нет. ✅ |

---

## Исправления после аудита (реализовано)

- **Orders:** на весь роутер подключён `authMiddleware`; для админских эндпоинтов — `requireRole(['ADMIN'])`; создание заказа и «мои заказы» используют только `req.user.userId`; GET /:id и POST /:id/cancel проверяют владельца (свой заказ или ADMIN).
- **Menu:** GET остаются публичными; для POST/PATCH/DELETE категорий и позиций — `authMiddleware` + `requireRole(['ADMIN'])`.
- **Statistics:** на весь роутер — `authMiddleware`; доступ к `/user/:userId` только если `req.user.userId === userId` или ADMIN; POST `/user/:userId/update` — `requireRole(['ADMIN'])`.
- **Achievements:** GET /types публичный; остальное за `authMiddleware`; GET `/user/:userId` и `/user/:userId/progress` — только свой userId или ADMIN; POST /check и /seed — `requireRole(['ADMIN'])`.
- **OrderService:** `createOrder` и `cancelOrder` обёрнуты в `AppDataSource.transaction()` (атомарность заказа и баланса).
- **Глобальный обработчик ошибок:** в `app.ts` добавлены middleware 404 (JSON `{ error: 'Not found' }`) и error handler для `next(err)` (единый формат, в production не отдаётся внутреннее сообщение/stack).
